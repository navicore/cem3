# Test Ed25519 digital signatures

# Test keypair generation
: test-ed25519-keypair ( -- )
  crypto.ed25519-keypair
  # Stack: public-key private-key
  string.byte-length 64 i.eq test.assert  # private key is 64 hex chars
  string.byte-length 64 i.eq test.assert  # public key is 64 hex chars
;

# Test sign and verify roundtrip
: test-ed25519-sign-verify ( -- )
  # Generate keypair
  crypto.ed25519-keypair
  # Stack: public-key private-key

  # Sign a message
  "Hello, World!" swap crypto.ed25519-sign
  # Stack: public-key signature success
  test.assert  # sign success

  # Stack: public-key signature
  # Verify the signature (message signature public-key -- valid)
  swap "Hello, World!" rot rot crypto.ed25519-verify
  test.assert  # verify should succeed
;

# Test verification fails with wrong message
: test-ed25519-wrong-message ( -- )
  crypto.ed25519-keypair
  # Stack: public-key private-key

  "Original message" swap crypto.ed25519-sign
  test.assert  # sign success
  # Stack: public-key signature

  # Verify with different message should fail
  swap "Different message" rot rot crypto.ed25519-verify
  test.assert-not  # should fail
;

# Test verification fails with wrong key
: test-ed25519-wrong-key ( -- )
  # Generate keypair and sign
  crypto.ed25519-keypair
  "Test message" swap crypto.ed25519-sign
  test.assert  # sign success
  # Stack: public-key signature

  # Generate a different keypair (wrong key)
  crypto.ed25519-keypair drop  # just get the public key, drop private
  # Stack: public-key signature wrong-public-key

  # Verify with wrong public key: (message signature public-key -- valid)
  "Test message" rot rot crypto.ed25519-verify
  # Stack: public-key valid
  test.assert-not  # should fail
  drop  # drop correct public-key
;

# Test sign with invalid key fails
: test-ed25519-invalid-key ( -- )
  "Test message" "tooshort" crypto.ed25519-sign
  test.assert-not  # should fail
  drop  # drop empty signature
;

# Test verify with invalid signature format
: test-ed25519-invalid-signature ( -- )
  crypto.ed25519-keypair
  drop  # drop private key
  # Stack: public-key

  "Test message" "invalid-signature" rot crypto.ed25519-verify
  test.assert-not  # should fail
;

# Test signing empty message works
: test-ed25519-empty-message ( -- )
  crypto.ed25519-keypair
  # Stack: public-key private-key

  "" swap crypto.ed25519-sign
  test.assert  # sign success
  # Stack: public-key signature

  swap "" rot rot crypto.ed25519-verify
  test.assert  # verify should succeed
;

