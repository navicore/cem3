# Tests for virtual register spill correctness (Issue #189)
#
# These tests verify that operations correctly spill virtual registers
# before accessing memory. Each test pushes integer literals (which use
# virtual registers) followed by an operation that must spill first.
#
# Without proper spills, these tests would produce incorrect results
# (typically zeros or garbage values).

# Stack operation tests - these were broken before the fix

: test-2dup-spills ( -- )
  3 4 2dup
  i.+ i.+ i.+   # 3 + 4 + 3 + 4 = 14
  14 test.assert-eq
;

: test-tuck-spills ( -- )
  3 4 tuck      # ( 3 4 -- 4 3 4 )
  i.+ i.+       # 4 + 3 + 4 = 11
  11 test.assert-eq
;

: test-nip-spills ( -- )
  3 4 nip       # ( 3 4 -- 4 )
  4 test.assert-eq
;

# Boolean operation tests

: test-and-spills ( -- )
  true true and
  test.assert
;

: test-or-spills ( -- )
  true false or
  test.assert
;

: test-not-spills ( -- )
  false not
  test.assert
;

: test-and-with-comparison ( -- )
  3 4 i.< 5 6 i.< and   # true and true
  test.assert
;

: test-or-with-comparison ( -- )
  3 4 i.> 5 6 i.< or    # false or true
  test.assert
;

# Float arithmetic tests

: test-f-add-spills ( -- )
  1.5 2.5 f.+
  4.0 f.= test.assert
;

: test-f-sub-spills ( -- )
  5.0 3.0 f.-
  2.0 f.= test.assert
;

: test-f-mul-spills ( -- )
  2.0 3.0 f.*
  6.0 f.= test.assert
;

: test-f-div-spills ( -- )
  6.0 2.0 f./
  3.0 f.= test.assert
;

# Float comparison tests

: test-f-eq-spills ( -- )
  3.0 3.0 f.=
  test.assert
;

: test-f-lt-spills ( -- )
  2.0 3.0 f.<
  test.assert
;

: test-f-gt-spills ( -- )
  3.0 2.0 f.>
  test.assert
;

: test-f-lte-spills ( -- )
  3.0 3.0 f.<=
  test.assert
;

: test-f-gte-spills ( -- )
  3.0 3.0 f.>=
  test.assert
;

: test-f-neq-spills ( -- )
  2.0 3.0 f.<>
  test.assert
;

# Combined operations - ensure spill works with mixed operations

: test-2dup-then-arithmetic ( -- )
  # Stack: 10 20 → 2dup → 10 20 10 20 → i.* → 10 20 200 → swap → 10 200 20 → i.* → 10 4000 → i.+ → 4010
  10 20 2dup i.* swap i.* i.+
  4010 test.assert-eq
;

: test-multiple-literals-then-tuck ( -- )
  1 2 3 tuck    # ( 1 2 3 -- 1 3 2 3 )
  i.+ i.+ i.+   # 1 + 3 + 2 + 3 = 9
  9 test.assert-eq
;

: test-chained-boolean-ops ( -- )
  true true and true and
  test.assert
;

: test-chained-float-comparisons ( -- )
  1.0 2.0 f.< 2.0 3.0 f.< and
  test.assert
;
