# Test weave (generator/coroutine) functionality
# Tests strand.weave, strand.resume, and yield operations
#
# IMPORTANT: Weaves must be resumed until completion or the program will hang!
# The WeaveCtx must be explicitly threaded through yield calls.

# Simple generator that yields three fixed values then completes
# Has Yield effect because it uses yield
: three-values ( Ctx Int -- Ctx | Yield Int )
  drop       # ignore initial resume value
  1 yield drop
  2 yield drop
  3 yield drop
  # implicit return - weave completes
;

# Test basic yield/resume flow
: test-basic-yield-resume ( -- )
  [ three-values ] strand.weave  # create weave
  0 strand.resume                # first resume
  test.assert                    # should have more
  1 test.assert-eq               # first yield is 1
  0 strand.resume
  test.assert
  2 test.assert-eq               # second yield is 2
  0 strand.resume
  test.assert
  3 test.assert-eq               # third yield is 3
  # weave is now waiting for resume - complete it
  0 strand.resume
  test.assert-not                # weave should be done
  drop drop                      # drop placeholder and handle
;

# Simple body that just returns without yielding
: return-immediately ( Ctx Int -- Ctx )
  drop  # drop the resume value
  # weave completes immediately
;

# Test weave completion detection
: test-weave-completion ( -- )
  [ three-values ] strand.weave
  0 strand.resume test.assert 1 test.assert-eq  # yield 1
  0 strand.resume test.assert 2 test.assert-eq  # yield 2
  0 strand.resume test.assert 3 test.assert-eq  # yield 3
  0 strand.resume                               # weave should complete
  test.assert-not                               # has_more should be false
  drop drop                                     # drop placeholder and handle
;

# Test immediate completion (no yields)
: test-immediate-completion ( -- )
  [ return-immediately ] strand.weave
  42 strand.resume               # resume - weave completes immediately
  test.assert-not                # has_more should be false
  drop drop                      # drop placeholder and handle
;

# Test cancellation - weave should be cleanly cancelled without hanging
: test-weave-cancel ( -- )
  [ three-values ] strand.weave  # create weave
  strand.weave-cancel            # cancel before first resume
  # If we get here without hanging, cancellation worked!
  true test.assert
;

# Test cancellation after partial resume
: test-weave-cancel-after-resume ( -- )
  [ three-values ] strand.weave  # create weave
  0 strand.resume                # first resume
  test.assert                    # should have more
  1 test.assert-eq               # first yield is 1
  strand.weave-cancel            # cancel after first yield
  # If we get here without hanging, cancellation worked!
  true test.assert
;

# NOTE: String yields would require explicit context threading for the string type.
# The type signature ( Ctx a -- Ctx a ) means yielded and resumed values have same type.

# Generator that yields extreme Int values (i64::MIN and i64::MIN+1)
# These were previously reserved as sentinels but are now valid user values
: extreme-values ( Ctx Int -- Ctx | Yield Int )
  drop                            # ignore initial resume value
  -9223372036854775808 yield drop # i64::MIN
  -9223372036854775807 yield drop # i64::MIN + 1
  9223372036854775807 yield drop  # i64::MAX
;

# Test that i64::MIN can be yielded (was previously a sentinel limitation)
: test-yield-i64-min ( -- )
  [ extreme-values ] strand.weave
  0 strand.resume
  test.assert                              # should have more
  -9223372036854775808 test.assert-eq      # should be exactly i64::MIN
  0 strand.resume
  test.assert
  -9223372036854775807 test.assert-eq      # i64::MIN + 1
  0 strand.resume
  test.assert
  9223372036854775807 test.assert-eq       # i64::MAX
  0 strand.resume
  test.assert-not                          # weave should complete
  drop drop
;
