# Test weave (generator/coroutine) functionality
# Tests strand.weave, strand.resume, and yield operations
#
# IMPORTANT: Weaves must be resumed until completion or the program will hang!
# The WeaveCtx must be explicitly threaded through yield calls.

# Simple generator that yields three fixed values then completes
: three-values ( Ctx Int -- Ctx )
  drop       # ignore initial resume value
  1 yield drop
  2 yield drop
  3 yield drop
  # implicit return - weave completes
;

# Test basic yield/resume flow
: test-basic-yield-resume ( -- )
  [ three-values ] strand.weave  # create weave
  0 strand.resume                # first resume
  test.assert                    # should have more
  1 test.assert-eq               # first yield is 1
  0 strand.resume
  test.assert
  2 test.assert-eq               # second yield is 2
  0 strand.resume
  test.assert
  3 test.assert-eq               # third yield is 3
  # weave is now waiting for resume - complete it
  0 strand.resume
  test.assert-not                # weave should be done
  drop drop                      # drop placeholder and handle
;

# Simple body that just returns without yielding
: return-immediately ( Ctx Int -- Ctx )
  drop  # drop the resume value
  # weave completes immediately
;

# Test weave completion detection
: test-weave-completion ( -- )
  [ three-values ] strand.weave
  0 strand.resume test.assert 1 test.assert-eq  # yield 1
  0 strand.resume test.assert 2 test.assert-eq  # yield 2
  0 strand.resume test.assert 3 test.assert-eq  # yield 3
  0 strand.resume                               # weave should complete
  test.assert-not                               # has_more should be false
  drop drop                                     # drop placeholder and handle
;

# Test immediate completion (no yields)
: test-immediate-completion ( -- )
  [ return-immediately ] strand.weave
  42 strand.resume               # resume - weave completes immediately
  test.assert-not                # has_more should be false
  drop drop                      # drop placeholder and handle
;

# NOTE: String yields would require explicit context threading for the string type.
# The type signature ( Ctx a -- Ctx a ) means yielded and resumed values have same type.
