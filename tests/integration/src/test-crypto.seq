# Test crypto operations (SHA-256, HMAC, Random, UUID)

# SHA-256 hashing
: test-sha256 ( -- )
  "hello" crypto.sha256
  "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824" test.assert-eq-str
;

: test-sha256-empty ( -- )
  "" crypto.sha256
  "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" test.assert-eq-str
;

: test-sha256-length ( -- )
  "anything" crypto.sha256 string.length
  64 test.assert-eq  # SHA-256 is always 64 hex chars
;

# HMAC-SHA256
: test-hmac-sha256 ( -- )
  "message" "secret" crypto.hmac-sha256
  "8b5f48702995c1598c573db1e21866a9b825d4a794d169d7060a03605796360b" test.assert-eq-str
;

: test-hmac-sha256-length ( -- )
  "data" "key" crypto.hmac-sha256 string.length
  64 test.assert-eq  # HMAC-SHA256 is always 64 hex chars
;

# Constant-time comparison
: test-constant-time-eq-equal ( -- )
  "hello" "hello" crypto.constant-time-eq
  test.assert
;

: test-constant-time-eq-different ( -- )
  "hello" "world" crypto.constant-time-eq
  test.assert-not
;

: test-constant-time-eq-different-length ( -- )
  "hello" "hi" crypto.constant-time-eq
  test.assert-not
;

: test-constant-time-eq-empty ( -- )
  "" "" crypto.constant-time-eq
  test.assert
;

# Random bytes
: test-random-bytes-length ( -- )
  16 crypto.random-bytes string.length
  32 test.assert-eq  # 16 bytes = 32 hex chars
;

: test-random-bytes-zero ( -- )
  0 crypto.random-bytes string.length
  0 test.assert-eq
;

: test-random-bytes-unique ( -- )
  32 crypto.random-bytes
  32 crypto.random-bytes
  crypto.constant-time-eq test.assert-not  # Should be different
;

# UUID v4
: test-uuid4-format ( -- )
  crypto.uuid4 string.length
  36 test.assert-eq  # UUID is 36 chars: 8-4-4-4-12
;

: test-uuid4-unique ( -- )
  crypto.uuid4
  crypto.uuid4
  crypto.constant-time-eq test.assert-not  # Should be different
;

: test-uuid4-contains-dashes ( -- )
  crypto.uuid4 "-" string.contains
  test.assert
;

# Practical use case: webhook verification pattern
: test-webhook-verification ( -- )
  # Simulate webhook payload and secret
  "payload-data" "webhook-secret" crypto.hmac-sha256
  # Recompute signature
  "payload-data" "webhook-secret" crypto.hmac-sha256
  # Verify they match using constant-time comparison
  crypto.constant-time-eq test.assert
;

: test-webhook-verification-wrong-secret ( -- )
  "payload-data" "correct-secret" crypto.hmac-sha256
  "payload-data" "wrong-secret" crypto.hmac-sha256
  crypto.constant-time-eq test.assert-not
;

