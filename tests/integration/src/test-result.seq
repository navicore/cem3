# Tests for std:result - Result/Option helpers
#
# Note: Some tests from the original test file were omitted because they rely on
# variant.field-at for extracting values from Ok/Err/Some variants. The current
# type system has limitations with generic field access on union variants.
# The omitted tests include: result-map, result-bind, and direct value extraction.
# These tests focus on predicates (result-ok?, result-err?, option-some?, option-none?)
# and unwrap-or operations which work correctly with the current implementation.

include std:result

# Define our test Result and Option types
union IntResult {
  Ok { value: Int }
  Err { error: String }
}

union IntOption {
  Some { value: Int }
  None
}

# =============================================================================
#                           RESULT TESTS
# =============================================================================

: test-result-ok-predicate ( -- )
  42 Make-Ok
  result-ok? test.assert
  drop
;

: test-result-ok-predicate-false ( -- )
  "error" Make-Err
  result-ok? not test.assert
  drop
;

: test-result-err-predicate ( -- )
  "error" Make-Err
  result-err? test.assert
  drop
;

: test-result-err-predicate-false ( -- )
  42 Make-Ok
  result-err? not test.assert
  drop
;

: test-result-unwrap-or-ok ( -- )
  42 Make-Ok 99 result-unwrap-or
  42 test.assert-eq
;

: test-result-unwrap-or-err ( -- )
  "error" Make-Err 99 result-unwrap-or
  99 test.assert-eq
;

# =============================================================================
#                           OPTION TESTS
# =============================================================================

: test-option-some-predicate ( -- )
  42 Make-Some
  option-some? test.assert
  drop
;

: test-option-some-predicate-false ( -- )
  Make-None
  option-some? not test.assert
  drop
;

: test-option-none-predicate ( -- )
  Make-None
  option-none? test.assert
  drop
;

: test-option-none-predicate-false ( -- )
  42 Make-Some
  option-none? not test.assert
  drop
;

: test-option-unwrap-or-some ( -- )
  42 Make-Some 99 option-unwrap-or
  42 test.assert-eq
;

: test-option-unwrap-or-none ( -- )
  Make-None 99 option-unwrap-or
  99 test.assert-eq
;

# =============================================================================
#                        OPTION COMBINATOR TESTS
# =============================================================================

# Helper: return Some if positive, None otherwise
: positive-or-none ( Int -- IntOption )
  dup 0 i.> if
    Make-Some
  else
    drop Make-None
  then
;

: test-option-bind-some-some ( -- )
  5 Make-Some [ positive-or-none ] option-bind
  option-some? test.assert
  drop
;

: test-option-bind-some-none ( -- )
  0 Make-Some [ positive-or-none ] option-bind
  option-none? test.assert
  drop
;

: test-option-bind-none ( -- )
  Make-None [ positive-or-none ] option-bind
  option-none? test.assert
  drop
;

: test-option-map-some ( -- )
  5 Make-Some [ 2 i.* ] option-map
  option-some? test.assert
  drop
;

: test-option-map-none ( -- )
  Make-None [ 2 i.* ] option-map
  option-none? test.assert
  drop
;
