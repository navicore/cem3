# Regression test for stack.dump with heap-allocated values
# Tests the fix for double-free bug when printing maps, variants, strings
# Issue: print_stack_value was consuming heap values via stack_value_to_value,
# then drop_stack_value would try to free already-freed memory.

include std:son

# Test that stack.dump correctly handles maps without crashing
: test-map-on-stack ( -- )
  # Create a map, let stack.dump handle it (implicitly via test harness)
  map-of "key" "value" kv
  # If we got here without crash, the fix works
  # Verify the map is valid by accessing it
  "key" map.get test.assert "value" string.equal? test.assert
;

# Test mixed heap values on stack
: test-mixed-heap-values ( -- )
  "hello"  # string (heap)
  map-of "a" 1 kv  # map (heap)
  # Stack: "hello" Map
  # Verify map is valid (map.get returns Bool Value)
  "a" map.get test.assert 1 test.assert-eq
  # Stack: "hello"
  # Verify string is valid
  "hello" string.equal? test.assert
;

# Test nested structures
: test-nested-structures ( -- )
  map-of
    "items" list-of 1 lv 2 lv 3 lv kv
    "count" 3 kv
  # Verify nested structure is intact (map.get returns Bool Value)
  "count" map.get test.assert 3 test.assert-eq
;

# Test list variant on stack (List is a known variant type)
: test-list-on-stack ( -- )
  list-of 1 lv 2 lv 3 lv
  # Verify list is valid by checking length
  list.length 3 test.assert-eq
;
