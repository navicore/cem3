# Test type-safe make-variant-N builtins
#
# These builtins properly account for field consumption in the type system,
# providing compile-time type safety for variant creation.

# 0 fields: empty variant
: make-empty ( -- Variant )
  0 variant.make-0 ;

# 1 field: wrap a value
: make-box ( Int -- Variant )
  1 variant.make-1 ;

# 2 fields: a pair
: make-pair ( Int String -- Variant )
  2 variant.make-2 ;

# 3 fields: a triple
: make-triple ( Int Int Int -- Variant )
  3 variant.make-3 ;

# 4 fields: a quad
: make-quad ( Int Int Int Int -- Variant )
  4 variant.make-4 ;

: test-empty ( -- )
  make-empty variant.tag 0 = if
    "PASS: variant.make-0" io.write-line
  else
    "FAIL: variant.make-0" io.write-line
  then
;

: test-box ( -- )
  42 make-box
  dup variant.tag 1 = if
    0 variant.field-at 42 = if
      "PASS: variant.make-1" io.write-line
    else
      "FAIL: variant.make-1 field" io.write-line
    then
  else
    drop "FAIL: variant.make-1 tag" io.write-line
  then
;

: test-pair ( -- )
  100 "hello" make-pair
  dup variant.tag 2 = if
    dup 0 variant.field-at 100 = if
      1 variant.field-at "hello" string.equal? if
        "PASS: variant.make-2" io.write-line
      else
        "FAIL: variant.make-2 field1" io.write-line
      then
    else
      drop "FAIL: variant.make-2 field0" io.write-line
    then
  else
    drop "FAIL: variant.make-2 tag" io.write-line
  then
;

: test-triple ( -- )
  1 2 3 make-triple
  dup variant.tag 3 = if
    dup 0 variant.field-at 1 = if
      dup 1 variant.field-at 2 = if
        2 variant.field-at 3 = if
          "PASS: variant.make-3" io.write-line
        else
          "FAIL: variant.make-3 field2" io.write-line
        then
      else
        drop "FAIL: variant.make-3 field1" io.write-line
      then
    else
      drop "FAIL: variant.make-3 field0" io.write-line
    then
  else
    drop "FAIL: variant.make-3 tag" io.write-line
  then
;

: test-quad ( -- )
  10 20 30 40 make-quad
  dup variant.tag 4 = if
    dup 0 variant.field-at 10 = if
      dup 1 variant.field-at 20 = if
        dup 2 variant.field-at 30 = if
          3 variant.field-at 40 = if
            "PASS: variant.make-4" io.write-line
          else
            "FAIL: variant.make-4 field3" io.write-line
          then
        else
          drop "FAIL: variant.make-4 field2" io.write-line
        then
      else
        drop "FAIL: variant.make-4 field1" io.write-line
      then
    else
      drop "FAIL: variant.make-4 field0" io.write-line
    then
  else
    drop "FAIL: variant.make-4 tag" io.write-line
  then
;

: main ( -- )
  test-empty
  test-box
  test-pair
  test-triple
  test-quad
;
